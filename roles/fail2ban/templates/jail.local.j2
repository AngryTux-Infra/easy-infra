# /etc/fail2ban/jail.local — Gerenciado pelo Ansible (easy-infra / role: fail2ban)
# NÃO edite manualmente. Alterações serão sobrescritas na próxima execução.
#
# IMPORTANTE: Este arquivo NUNCA deve editar jail.conf.
# Todas as customizações ficam exclusivamente neste jail.local.

[DEFAULT]

# Duração do ban (em segundos). Valores negativos = ban permanente.
bantime  = {{ f2b_bantime }}

# IPs/redes excluídos do ban (nunca serão banidos pelo fail2ban).
ignoreip = {{ f2b_ignoreip }}

# Janela de tempo na qual as tentativas são contadas (em segundos).
findtime = {{ f2b_findtime }}

# Número máximo de falhas antes do ban ser aplicado.
maxretry = {{ f2b_maxretry }}

# Ação de ban: usa UFW como backend para integração com o firewall.
# Requer que o UFW esteja habilitado (configurado pela role firewall).
banaction = ufw

# Envia notificações apenas para o log local (sem MTA configurado por padrão).
mta = sendmail

# Protocolo padrão para os jails que não especificam o próprio.
protocol = tcp

# ==============================================================================
# Jail: sshd — Proteção contra força bruta no SSH
# ==============================================================================

[sshd]

enabled  = true
port     = {{ ssh_port }}
filter   = sshd
logpath  = /var/log/auth.log

# systemd é o backend preferido em Debian/Ubuntu modernos com journald.
# Ignora o logpath acima quando ativo; mantido como fallback documental.
backend  = systemd

maxretry = {{ f2b_maxretry }}

# ==============================================================================
# Jail: recidive — Ban progressivo para reincidentes
#
# Bane IPs que já foram banidos múltiplas vezes por outros jails.
# Atua como segunda camada de proteção para atacantes persistentes.
# ==============================================================================

[recidive]

enabled   = true
filter    = recidive
logpath   = /var/log/fail2ban.log
banaction = ufw

# Ban para reincidentes (parametrizado via defaults/group_vars).
bantime   = {{ f2b_recidive_bantime }}

# Janela de observação: 1 dia (86400 segundos).
findtime  = 86400

# Bane após ser banido 5 vezes por outros jails dentro da janela.
maxretry  = 5
