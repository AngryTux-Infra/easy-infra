---
# roles/users/tasks/main.yml
# Tradução de scripts/04-users.sh

- name: Criar usuário administrador
  user:
    name: "{{ admin_user }}"
    home: "{{ admin_home }}"
    shell: "{{ admin_shell }}"
    groups: "{{ admin_groups }}"
    append: true
    create_home: true
    comment: "Admin user managed by easy-infra"
    state: present

- name: Deploy SSH key for admin user (exclusive)
  ansible.builtin.authorized_key:
    user: "{{ admin_user }}"
    key: "{{ admin_ssh_key }}"
    exclusive: true
    state: present
  when: admin_ssh_key != ""
  tags: [users, ssh]

- name: Instalar configuração sudoers para o usuário admin
  copy:
    src: admin-nopasswd
    dest: "{{ sudoers_dest }}"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"

- name: Travar senha do root
  ansible.builtin.user:
    name: root
    password_lock: true
  tags: [users, security]

- name: Restringir su ao grupo admin via PAM
  ansible.builtin.lineinfile:
    path: /etc/pam.d/su
    regexp: '^#?\s*auth\s+required\s+pam_wheel\.so'
    line: 'auth       required   pam_wheel.so group={{ admin_groups | first }}'
    state: present
  tags: [users, security]
