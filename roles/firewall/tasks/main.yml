---
# roles/firewall/tasks/main.yml — Configuração de firewall com UFW
# Migrado de scripts/03-firewall.sh

- name: Instalar UFW
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Definir política padrão — bloquear entrada
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Definir política padrão — permitir saída
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Liberar porta SSH com rate limiting (apenas LAN)
  community.general.ufw:
    rule: limit
    port: "{{ ssh_port }}"
    proto: tcp
    from_ip: "{{ networks.lan.cidr }}"
    comment: "SSH from LAN"
  when: ssh_restrict_to_lan | default(true)
  tags: [firewall]

- name: Liberar porta SSH com rate limiting (irrestrito)
  community.general.ufw:
    rule: limit
    port: "{{ ssh_port }}"
    proto: tcp
    comment: "SSH"
  when: not (ssh_restrict_to_lan | default(true))
  tags: [firewall]

- name: Liberar portas adicionais
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop: "{{ allowed_ports }}"
  when: allowed_ports | length > 0

- name: Liberar IPs/redes confiáveis
  community.general.ufw:
    rule: allow
    from_ip: "{{ item }}"
  loop: "{{ firewall_allowed_ips }}"
  when: firewall_allowed_ips | length > 0

- name: Remover regra legada da porta 22 quando SSH usa porta alternativa
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    delete: true
  when: ssh_port | string != "22"
  failed_when: false

- name: Remover regra legada da porta 22 com rate limit
  community.general.ufw:
    rule: limit
    port: "22"
    proto: tcp
    delete: true
  when: ssh_port | string != "22"
  failed_when: false

- name: Habilitar UFW
  community.general.ufw:
    state: enabled
