---
# roles/ssh/tasks/main.yml — Tasks da role ssh

- name: Instalar o pacote openssh-server
  ansible.builtin.apt:
    name: openssh-server
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Criar o grupo ssh-access para controle de acesso SSH
  ansible.builtin.group:
    name: "{{ ssh_allow_groups }}"
    state: present
  tags: [ssh, security]

- name: Adicionar {{ admin_user }} ao grupo {{ ssh_allow_groups }}
  ansible.builtin.user:
    name: "{{ admin_user }}"
    groups: "{{ ssh_allow_groups }}"
    append: true
  tags: [ssh, security]

- name: Fazer deploy do sshd_config a partir do template
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: "sshd -t -f %s"
    backup: true
  notify: restart sshd

- name: Fazer deploy do banner SSH
  ansible.builtin.copy:
    src: ssh_banner.txt
    dest: "{{ ssh_banner_path }}"
    owner: root
    group: root
    mode: "0644"

- name: Garantir que o serviço sshd está habilitado e em execução
  ansible.builtin.systemd:
    name: "{{ 'sshd' if ansible_service_mgr == 'systemd' and ansible_facts.services is defined and 'sshd.service' in ansible_facts.services else 'ssh' }}"
    enabled: true
    state: started

# Port transition: flush handlers now so sshd restarts before we proceed.
# Then wait for the new port and tell Ansible to reconnect on it.
- name: Flush handlers para reiniciar sshd imediatamente
  ansible.builtin.meta: flush_handlers

- name: Aguardar nova porta SSH ficar disponível
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: "{{ ssh_port }}"
    delay: 2
    timeout: 30
  delegate_to: localhost
  become: false

- name: Atualizar ansible_port para a nova porta SSH
  ansible.builtin.set_fact:
    ansible_port: "{{ ssh_port }}"

- name: Resetar conexão SSH para usar a nova porta
  ansible.builtin.meta: reset_connection
